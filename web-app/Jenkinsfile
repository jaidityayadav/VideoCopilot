pipeline {
    agent any

    environment {
        APP_NAME = "videocopilot-web-app"
        REPO_URL = "git@github.com:jaidityayadav/VideoCopilot.git"
        BRANCH = "main"
        APP_DIR = "/home/ec2-user/VideoCopilot"
        NODE_ENV = "production"
        SSH_KEY_ID = "git" // Jenkins credential ID for your SSH key
    }

    stages {
        stage('Checkout via SSH') {
            steps {
                sshagent([env.SSH_KEY_ID]) {
                    sh """
                        rm -rf ${APP_DIR}
                        git clone -b ${BRANCH} ${REPO_URL} ${APP_DIR}
                    """
                }
            }
        }

        stage('Install Dependencies') {
            steps {
                dir("${APP_DIR}/web-app") {
                    sh "npm ci"
                }
            }
        }

        stage('Prisma Setup') {
            steps {
                dir("${APP_DIR}/web-app") {
                    sh "npx prisma generate"
                    sh "npx prisma migrate deploy || true"
                }
            }
        }

        stage('Run Application') {
            steps {
                dir("${APP_DIR}/web-app") {
                    sh "pm2 start npm --name ${APP_NAME} -- start"
                }
            }
        }
    }

    post {
        success {
            echo "Deployment successful!"
        }
        failure {
            echo "Deployment failed."
        }
    }
}
